<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
  .link {
    stroke: gray;
    stroke-width: 1.5px;
  }

  .node {
    /*fill: #66CC66;*/
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }
  
  path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  Scale:
    <label><input type="radio" name="scale" value="linear" checked>Linear</label>
    <label><input type="radio" name="scale" value="time">Time</label>
  </form>

<script>

var width = 1000,
    height = 700;

var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

var fill = d3.scale.category10();
var git = "afaqurk/linux-dash";
var graph = {nodes:[], links:[]};
var parents ={parents:[], source:[]};
var nb_nodes = 100, nb_cat = 10;
var names = [ ];
var remaining = 1

//Get Branch Data


var branchD = d3.json("https://api.github.com/repos/"+git+"/branches", function(error, data1){
		names = data1.map(function(d, i){
			//if(names.length <=3){
				return data1[i].name;
			//}
		});
	if(! --remaining) commitD();
});

function commitD(){
	remaining = names.length;
	names.forEach(function(d, i){
	
  var dataset = d3.json("https://api.github.com/repos/"+git+"/commits"+"?sha="+names[i], function(error, data){

console.log(names[i]);
data.map(function(e, j) {  
  graph.nodes.push( { sha: data[j].sha, commit: data[j].commit, branch: names[i], date: Date.parse(data[j].commit.author.date),
  parents: data[j].parents } );
}); 


graph.nodes.map(function(d, i){
	//d.date=Date.parse(graph.nodes[i].date);
	//console.log(d.date);
	graph.nodes.sort(function(a, b){
		return d3.ascending(a.date, b.date);
	});
});

data.map(function(d, i){
	data[i].parents.map(function(e, j) {
		parents.parents.push({"parents":e });
		parents.source.push({"source":data[i].sha});
	})
})

 if(! --remaining) map();
});
})

}


function map (){

	svg
	.append("g")
    .attr("class", "branches")
	.selectAll("text")
	.data(names)
    .enter()
    .append("text")
    .text(function(d) { return d; })
    .attr("y", function(d, i) { 
    	//console.log(d);
    	if(d=="master"){
    		return height/3;
    	}else{
    		return (height/3)+(30*(i+1));
    	}
    });

var display = svg.append("g").attr("class", "display");

set_links();
//console.log(graph);

function set_links(){
	//sets up links
graph.nodes.map(function(d, i){
	graph.nodes[i].parents.map(function(l, m){
		graph.nodes.map(function(e, j){
			if(e.sha == l.sha){
				graph.links.push({"source":i, "target":j});
			}
		})
	})
})

}

console.log(graph);

// Generate the force layout
var force = d3.layout.force()
    .size([width, height])
    .charge(-50)
    .linkDistance(10)
    .on("tick", tick)
    .on("start", function(d) {})
    .on("end", function(d) {})

function tick(d) {

  graph_update(0);
}


function force_layout() {

 force.nodes(graph.nodes)
      .links(graph.links)
      .start();
}

var xScale = d3.scale.ordinal()
                .domain(d3.range(graph.nodes.length))
                .rangeRoundBands([20, width], 1);
                //console.log(graph.nodes.length);

var min = d3.min(graph.nodes, function(d){
	return d.date;
});

//console.log(min);

var max = d3.max(graph.nodes, function(d){
	return d.date;
});

var tScale = d3.time.scale()
			.domain([min, max])
			.range([60, width-20]);
			
function time(){
	graph.nodes.forEach(function(d, i) {
    	 d.x = tScale(d.date);
  });
  graph_update(500);

};


function line_layout() {

  force.stop();

  graph.nodes.forEach(function(d, i) {
    //console.log(graph.nodes[i].branch);
    d.x = xScale(i);
    if(graph.nodes[i].branch=="master"){
    	d.y = height/3;
    }else{
    	names.forEach(function(e, j){
    		if(graph.nodes[i].branch==e){
    			//console.log(e);
    			d.y = (height/3)+(30*(j+1) );
    		}	
    	
    	} );
    	
    	//d.y = (height/2)+30;
    }

  });
  

  graph_update(500);
}



function category_color() {
  d3.selectAll("circle").transition().duration(500).style("fill", function(d) { return fill(d.cat); });
}

function category_size() {
  d3.selectAll("circle").transition().duration(500).attr("r", function(d) { return Math.sqrt((d.cat+1)*10); });
}

function graph_update(delay) {
	
	      
var line=  d3.svg.line()
			.x(function(d) { return d.x; })
			.y(function(d) { return d.y; })
			.interpolate("linear"); 
	  
  link.transition().duration(delay)
      .attr("x1", function(d) { return d.target.x; })
      .attr("y1", function(d) { return d.target.y; })
      .attr("x2", function(d) { return d.source.x; })
      .attr("y2", function(d) { return d.source.y; })
      .attr("d", function(d){
      			return line([{x:d.target.x, y:d.target.y}, 
				{x:d.target.x, y:d.target.y+10},
				{x:d.source.x, y:d.source.y+10}, 
				{x:d.source.x, y:d.source.y} ])
				});

  node.transition().duration(delay)
      .attr("transform", function(d) { 
        return "translate("+d.x+","+d.y+")"; 
      });
    //console.log(graph);
}

d3.select("input[value=\"linear\"]").on("click", line_layout );
d3.select("input[value=\"time\"]").on("click", time);


// build the arrow.
display.append("svg:defs").selectAll("marker")
    .data(["end"])      // Different link/path types can be defined here
  .enter().append("svg:marker")    // This section adds in the arrows
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 15)
    .attr("refY", -1.5)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
  	.append("svg:path")
    .attr("d", "M0,-5L10,0L0,5");
    
//console.log("It is "+ graph.links[0].source.n);

    
var line=  d3.svg.line()
			.x(function(d) { return d.x; })
			.y(function(d) { return d.y; })
			.interpolate("linear");    
     
var link = display.selectAll(".link")
            .data(graph.links)
            .enter().append("path")
            //.attr("d", line(lineData))
            .attr("class", "link")
            .attr("marker-end", "url(#end)");

var node = display.selectAll(".node")
              .data(graph.nodes)
            .enter()
              .append("g").attr("class", "node");

node.append("circle")
    .attr("r", 5)
    .attr("fill", function(d) {
		if(d.branch=="master"){
			return "blue";
		}else{
			return "#66CC66";
		}
   })
   .on("mouseover", function(d) {
   		d3.select(this).attr("fill", "red");
   })
   .on("mouseout", function(d){
   		d3.select(this).attr("fill", function(d) {
			if(d.branch=="master"){
				return "blue";
			}else{
				return "#66CC66";
			}
		});
   })
    .append("title")
   .text(function(d, i) {
        return d.branch;
   });

force_layout();
line_layout();
}


</script>
</body>
</html>